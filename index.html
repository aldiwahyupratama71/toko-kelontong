<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Toko Kelontong - Demo Fitur</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
      
    body {
      background: url('/path/to/your/background.jpg') center/cover no-repeat;
      min-height: 100vh;
    }
    .card-product { min-height: 150px; }
    .stok-badge { font-size: .9rem; padding: .25rem .5rem; border-radius: 6px; display:inline-block; }
    .stok-tersedia { background: #e6ffed; color: #0a7a3a; }
    .stok-menipis { background: #fff6e6; color: #8a5b00; }
    .stok-habis { background: #ffe6e6; color: #a30000; }
    .cart-count { position: relative; }
    .cart-count .badge { position:absolute; top:-8px; right:-8px; }
    .container-overlay { background: rgba(255,255,255,0.9); padding: 2rem; border-radius: 10px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <a class="navbar-brand" href="#">Toko Kelontong</a>
    <div class="ms-auto">
      <button id="cartBtn" class="btn btn-outline-light cart-count position-relative">
        ðŸ›’ Keranjang <span id="cartBadge" class="badge bg-danger">0</span>
      </button>
    </div>
  </div>
</nav>

<div class="container my-4 container-overlay">
  <h1 class="mb-3">WELCOME IN STORE MR.AL</h1>

  <!-- Search + Filter + Promo -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <input id="searchInput" type="text" class="form-control" placeholder="Search a product...">
        <button id="searchBtn" class="btn btn-outline-secondary">Cari</button>
      </div>
    </div>

    <div class="col-md-3">
      <select id="categoryFilter" class="form-select">
        <option value="">Semua Kategori</option>
        <option value="makanan">Makanan</option>
        <option value="minuman">Minuman</option>
        <option value="perlengkapan">Perlengkapan</option>
        <option value="lainnya">Lainnya</option>
      </select>
    </div>

    <div class="col-md-3">
      <div class="input-group">
        <input id="promoInput" class="form-control" placeholder="Kode promo (mis: DISKON10)">
        <button id="applyPromoBtn" class="btn btn-success">Apply</button>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Produk -->
    <div class="col-lg-8">
      <h4>Daftar Produk</h4>
      <div id="productsGrid" class="row g-3">
        <!-- Produk akan dirender di sini -->
      </div>
    </div>

    <!-- Keranjang & Riwayat -->
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h5>Keranjang Belanja</h5>
          <div id="cartList"></div>
          <hr/>
          <p>Total: <strong id="cartTotal">Rp 0</strong></p>
          <button id="checkoutBtn" class="btn btn-success">Checkout</button>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h6>Riwayat Pembelian</h6>
          <ul id="historyList" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Optional: modal untuk konfirmasi hapus -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        Hapus item dari keranjang?
        <div class="text-end mt-3">
          <button id="cancelRemove" class="btn btn-secondary btn-sm">Batal</button>
          <button id="confirmRemove" class="btn btn-danger btn-sm">Hapus</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== DATA PRODUK (contoh) ======
   Struktur: id, name, price (integer), category, stock (number)
   stock > 5 => tersedia, 1-5 => menipis, 0 => habis
*/
const PRODUCTS = [
  {id:1, name:"Minyak Goreng", price:25000, category:"makanan", stock:10},
  {id:2, name:"Gula Pasir", price:12000, category:"makanan", stock:2},
  {id:3, name:"Mie Instan", price:3000, category:"makanan", stock:0},
  {id:4, name:"Sabun Mandi", price:7000, category:"perlengkapan", stock:8},
  {id:5, name:"Telur Ayam (1 kg)", price:23000, category:"makanan", stock:6},
  {id:6, name:"Beras Medium (5 kg)", price:62000, category:"makanan", stock:1},
  {id:7, name:"Teh Celup", price:5000, category:"minuman", stock:15},
  {id:8, name:"Kopi Sachet", price:2000, category:"minuman", stock:20}
];

let cart = {}; // { productId: qty }
let history = []; // array transaksi
let pendingRemoveId = null;
let appliedPromo = null;

/* Utility format rupiah */
function formatRupiah(n){
  return 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

/* ====== RENDER PRODUK ====== */
const productsGrid = document.getElementById('productsGrid');

function getStockClass(stock){
  if(stock <= 0) return {cls:'stok-habis', text:'Habis'};
  if(stock <= 5) return {cls:'stok-menipis', text:'Stok menipis'};
  return {cls:'stok-tersedia', text:'Stok tersedia'};
}

function renderProducts(filterText='', category=''){
  productsGrid.innerHTML = '';
  const search = filterText.trim().toLowerCase();
  PRODUCTS.filter(p=>{
    if(category && p.category !== category) return false;
    if(search && !p.name.toLowerCase().includes(search)) return false;
    return true;
  }).forEach(p=>{
    const stockInfo = getStockClass(p.stock);
    const disabledAdd = p.stock <= 0 ? 'disabled' : '';
    const col = document.createElement('div');
    col.className = 'col-md-6';
    col.innerHTML = `
      <div class="card card-product">
        <div class="card-body">
          <h5 class="card-title">${p.name}</h5>
          <p class="card-text">${formatRupiah(p.price)}</p>
          <div class="mb-2">
            <span class="stok-badge ${stockInfo.cls}">${stockInfo.text}</span>
          </div>
          <div>
            <button class="btn btn-primary btn-sm" ${disabledAdd} onclick="addToCart(${p.id})">Tambah</button>
          </div>
        </div>
      </div>
    `;
    productsGrid.appendChild(col);
  });
}

/* ====== CART HANDLING ====== */
const cartBadge = document.getElementById('cartBadge');
const cartList = document.getElementById('cartList');
const cartTotalEl = document.getElementById('cartTotal');

function saveState(){
  localStorage.setItem('demo_cart', JSON.stringify(cart));
  localStorage.setItem('demo_history', JSON.stringify(history));
  localStorage.setItem('demo_promo', JSON.stringify(appliedPromo));
}

function loadState(){
  const c = localStorage.getItem('demo_cart');
  const h = localStorage.getItem('demo_history');
  const p = localStorage.getItem('demo_promo');
  if(c) cart = JSON.parse(c);
  if(h) history = JSON.parse(h);
  if(p) appliedPromo = JSON.parse(p);
}

function updateCartUI(){
  // update badge
  const totalItems = Object.values(cart).reduce((s,q)=>s+q,0);
  cartBadge.textContent = totalItems;
  // list
  cartList.innerHTML = '';
  if(totalItems === 0){
    cartList.innerHTML = '<p class="text-muted">Keranjang kosong</p>';
  } else {
    for(const idStr of Object.keys(cart)){
      const id = parseInt(idStr);
      const qty = cart[id];
      const product = PRODUCTS.find(p=>p.id===id);
      const item = document.createElement('div');
      item.className = 'd-flex justify-content-between align-items-center mb-2';
      item.innerHTML = `
        <div>
          <strong>${product.name}</strong><br/>
          <small>${formatRupiah(product.price)} x ${qty}</small>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="changeQty(${id}, -1)">-</button>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="changeQty(${id}, 1)">+</button>
          <button class="btn btn-sm btn-outline-danger" onclick="confirmRemove(${id})">Hapus</button>
        </div>
      `;
      cartList.appendChild(item);
    }
  }
  // total
  const rawTotal = Object.entries(cart).reduce((s,[id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===parseInt(id));
    return s + (p ? p.price*qty : 0);
  }, 0);
  let finalTotal = rawTotal;
  if(appliedPromo){
    if(appliedPromo.type === 'nominal') finalTotal = Math.max(0, rawTotal - appliedPromo.value);
  }
  cartTotalEl.textContent = formatRupiah(finalTotal);
  saveState();
}

/* Add / change qty */
function addToCart(productId){
  const product = PRODUCTS.find(p=>p.id===productId);
  if(!product || product.stock <= 0){
    alert('Maaf, produk habis.');
    return;
  }
  cart[productId] = (cart[productId] || 0) + 1;
  // optional: decrement stock locally (demo)
  product.stock = Math.max(0, product.stock - 1);
  renderProducts(document.getElementById('searchInput').value, document.getElementById('categoryFilter').value);
  updateCartUI();
}

function changeQty(productId, delta){
  if(!cart[productId]) return;
  const newQty = cart[productId] + delta;
  if(newQty <= 0){
    delete cart[productId];
  } else {
    cart[productId] = newQty;
  }
  // For demo: we won't restore stock automatically here to keep logic simple.
  updateCartUI();
}

function confirmRemove(productId){
  // simple confirm modal flow
  pendingRemoveId = productId;
  if(confirm('Hapus item dari keranjang?')) {
    delete cart[productId];
    updateCartUI();
    pendingRemoveId = null;
  }
}

/* Promo sederhana */
document.getElementById('applyPromoBtn').addEventListener('click', ()=>{
  const code = document.getElementById('promoInput').value.trim().toUpperCase();
  if(!code) { alert('Masukkan kode promo.'); return; }
  // contoh aturan promo: DISKON10 => potong Rp 10000, POTONG5 => Rp 5000
  if(code === 'DISKON10') {
    appliedPromo = {code, type:'nominal', value:10000};
    alert('Promo diterapkan: potongan Rp 10.000');
  } else if(code === 'POTONG5'){
    appliedPromo = {code, type:'nominal', value:5000};
    alert('Promo diterapkan: potongan Rp 5.000');
  } else {
    appliedPromo = null;
    alert('Kode promo tidak valid.');
  }
  updateCartUI();
});

/* Search + filter */
document.getElementById('searchBtn').addEventListener('click', ()=>{
  renderProducts(document.getElementById('searchInput').value, document.getElementById('categoryFilter').value);
});
document.getElementById('searchInput').addEventListener('input', (e)=>{
  // live search (optional)
  renderProducts(e.target.value, document.getElementById('categoryFilter').value);
});
document.getElementById('categoryFilter').addEventListener('change', ()=>{
  renderProducts(document.getElementById('searchInput').value, document.getElementById('categoryFilter').value);
});

/* Checkout */
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  const totalItems = Object.values(cart).reduce((s,q)=>s+q,0);
  if(totalItems === 0){ alert('Keranjang kosong'); return; }
  // Buat transaksi ringkas
  const transaction = {
    id: history.length + 1,
    items: Object.entries(cart).map(([id,qty])=>{
      const p = PRODUCTS.find(x=>x.id===parseInt(id));
      return { id: p.id, name: p.name, price: p.price, qty };
    }),
    subtotal: Object.entries(cart).reduce((s,[id,qty])=>{
      const p = PRODUCTS.find(x=>x.id===parseInt(id));
      return s + p.price*qty;
    }, 0),
    promo: appliedPromo,
    timestamp: new Date().toISOString()
  };
  transaction.total = transaction.subtotal - (appliedPromo ? appliedPromo.value : 0);
  if(transaction.total < 0) transaction.total = 0;
  history.unshift(transaction);
  // kosongkan keranjang
  cart = {};
  appliedPromo = null;
  saveState();
  updateCartUI();
  renderHistory();
  // buat struk sederhana sebagai file teks dan download
  const receiptLines = [];
  receiptLines.push('--- Toko Kelontong ---');
  receiptLines.push('Transaksi #' + transaction.id);
  receiptLines.push('Tanggal: ' + new Date(transaction.timestamp).toLocaleString());
  receiptLines.push('');
  transaction.items.forEach(it => {
    receiptLines.push(`${it.name} x${it.qty} = ${formatRupiah(it.price * it.qty)}`);
  });
  receiptLines.push('');
  receiptLines.push('Subtotal: ' + formatRupiah(transaction.subtotal));
  if(transaction.promo) receiptLines.push('Promo ('+transaction.promo.code+'): -' + formatRupiah(transaction.promo.value));
  receiptLines.push('Total: ' + formatRupiah(transaction.total));
  receiptLines.push('Terima kasih sudah berbelanja!');
  downloadTextFile(receiptLines.join('\\n'), `struk_transaksi_${transaction.id}.txt`);
});

/* Helper download */
function downloadTextFile(text, filename){
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Riwayat */
function renderHistory(){
  const ul = document.getElementById('historyList');
  ul.innerHTML = '';
  if(history.length === 0) {
    ul.innerHTML = '<li class="text-muted">Belum ada transaksi</li>';
    return;
  }
  history.forEach(tx=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>Transaksi #${tx.id}:</strong> ${tx.items.map(i=>i.name+' x'+i.qty).join(', ')} <br/><small>Total: ${formatRupiah(tx.total)}</small>`;
    ul.appendChild(li);
  });
}

/* Init */
loadState();
renderProducts();
updateCartUI();
renderHistory();
</script>

</body>
</html>

<nav class="navbar navbar-expand-lg navbar-dark bg-success">
  <div class="container">
    <a class="navbar-brand" href="#">Toko Kelontong</a>
    <div class="ms-auto">
      <button id="cartBtn" class="btn btn-outline-light cart-count position-relative">
        ðŸ›’ Keranjang <span id="cartBadge" class="badge bg-danger">0</span>
      </button>
      <!-- Tombol Logout -->
      <a href="logout.html" class="btn btn-danger ms-2">Logout</a>
    </div>
  </div>
</nav>
